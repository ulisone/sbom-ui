import { Controller } from "@hotwired/stimulus"
import { Chart, registerables } from "chart.js"

Chart.register(...registerables)

export default class extends Controller {
  static targets = ["severityChart", "trendChart"]
  static values = {
    severity: Object,
    trends: Array
  }

  connect() {
    if (this.hasSeverityChartTarget && this.hasSeverityValue) {
      this.initSeverityChart()
    }
    if (this.hasTrendChartTarget && this.hasTrendsValue) {
      this.initTrendChart()
    }
  }

  disconnect() {
    if (this.severityChart) this.severityChart.destroy()
    if (this.trendChart) this.trendChart.destroy()
  }

  initSeverityChart() {
    const ctx = this.severityChartTarget.getContext("2d")
    const severity = this.severityValue

    this.severityChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Critical", "High", "Medium", "Low"],
        datasets: [{
          data: [
            severity.critical || 0,
            severity.high || 0,
            severity.medium || 0,
            severity.low || 0
          ],
          backgroundColor: [
            "rgb(220, 38, 38)",   // red-600
            "rgb(234, 88, 12)",   // orange-600
            "rgb(202, 138, 4)",   // yellow-600
            "rgb(22, 163, 74)"    // green-600
          ],
          borderWidth: 0,
          hoverOffset: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "60%",
        plugins: {
          legend: {
            position: "right",
            labels: {
              color: "rgb(156, 163, 175)",
              padding: 16,
              usePointStyle: true,
              pointStyle: "circle"
            }
          },
          tooltip: {
            backgroundColor: "rgba(17, 24, 39, 0.95)",
            padding: 12,
            cornerRadius: 8,
            callbacks: {
              label: (context) => {
                const total = context.dataset.data.reduce((a, b) => a + b, 0)
                const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0
                return `${context.label}: ${context.raw} (${percentage}%)`
              }
            }
          }
        }
      }
    })
  }

  initTrendChart() {
    const ctx = this.trendChartTarget.getContext("2d")
    const trends = this.trendsValue

    const labels = trends.map(t => {
      const date = new Date(t.date)
      return date.toLocaleDateString("ko-KR", { month: "short", day: "numeric" })
    })

    this.trendChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Critical",
            data: trends.map(t => t.critical || 0),
            borderColor: "rgb(220, 38, 38)",
            backgroundColor: "rgba(220, 38, 38, 0.1)",
            fill: true,
            tension: 0.3
          },
          {
            label: "High",
            data: trends.map(t => t.high || 0),
            borderColor: "rgb(234, 88, 12)",
            backgroundColor: "rgba(234, 88, 12, 0.1)",
            fill: true,
            tension: 0.3
          },
          {
            label: "Medium",
            data: trends.map(t => t.medium || 0),
            borderColor: "rgb(202, 138, 4)",
            backgroundColor: "rgba(202, 138, 4, 0.1)",
            fill: true,
            tension: 0.3
          },
          {
            label: "Low",
            data: trends.map(t => t.low || 0),
            borderColor: "rgb(22, 163, 74)",
            backgroundColor: "rgba(22, 163, 74, 0.1)",
            fill: true,
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false
        },
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              color: "rgb(156, 163, 175)",
              usePointStyle: true,
              padding: 16
            }
          },
          tooltip: {
            backgroundColor: "rgba(17, 24, 39, 0.95)",
            padding: 12,
            cornerRadius: 8
          }
        },
        scales: {
          x: {
            grid: { color: "rgba(75, 85, 99, 0.2)" },
            ticks: { color: "rgb(156, 163, 175)" }
          },
          y: {
            grid: { color: "rgba(75, 85, 99, 0.2)" },
            ticks: { color: "rgb(156, 163, 175)" },
            beginAtZero: true
          }
        }
      }
    })
  }
}
