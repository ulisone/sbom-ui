class Vulnerability < ApplicationRecord
  belongs_to :scan

  validates :cve_id, presence: true
  validates :severity, presence: true, inclusion: { in: %w[CRITICAL HIGH MEDIUM LOW UNKNOWN] }

  SEVERITIES = %w[CRITICAL HIGH MEDIUM LOW UNKNOWN].freeze
  SEVERITY_ORDER = { "CRITICAL" => 0, "HIGH" => 1, "MEDIUM" => 2, "LOW" => 3, "UNKNOWN" => 4 }.freeze

  scope :critical, -> { where(severity: "CRITICAL") }
  scope :high, -> { where(severity: "HIGH") }
  scope :medium, -> { where(severity: "MEDIUM") }
  scope :low, -> { where(severity: "LOW") }
  scope :by_severity, -> { order(Arel.sql("CASE severity WHEN 'CRITICAL' THEN 0 WHEN 'HIGH' THEN 1 WHEN 'MEDIUM' THEN 2 WHEN 'LOW' THEN 3 ELSE 4 END")) }

  def severity_badge_class
    case severity
    when "CRITICAL" then "badge-critical"
    when "HIGH" then "badge-high"
    when "MEDIUM" then "badge-medium"
    when "LOW" then "badge-low"
    else "badge"
    end
  end

  def affected_package
    package_version.present? ? "#{package_name}@#{package_version}" : package_name
  end

  def has_fix?
    fixed_version.present?
  end

  def reference_urls
    references.is_a?(Array) ? references : []
  end
end
