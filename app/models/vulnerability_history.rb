# Tracks vulnerability changes across scans
class VulnerabilityHistory < ApplicationRecord
  belongs_to :project
  belongs_to :scan, optional: true

  # Event types
  DISCOVERED = "discovered".freeze    # New vulnerability found
  FIXED = "fixed".freeze              # Vulnerability fixed (no longer present)
  UPGRADED = "upgraded".freeze        # Severity changed (e.g., Medium -> Critical)
  DOWNGRADED = "downgraded".freeze    # Severity decreased
  REAPPEARED = "reappeared".freeze    # Previously fixed vulnerability reappeared

  EVENT_TYPES = [DISCOVERED, FIXED, UPGRADED, DOWNGRADED, REAPPEARED].freeze

  validates :vulnerability_id, presence: true
  validates :event_type, presence: true, inclusion: { in: EVENT_TYPES }
  validates :occurred_at, presence: true

  scope :recent, -> { order(occurred_at: :desc) }
  scope :discovered, -> { where(event_type: DISCOVERED) }
  scope :fixed, -> { where(event_type: FIXED) }
  scope :severity_changes, -> { where(event_type: [UPGRADED, DOWNGRADED]) }
  scope :for_project, ->(project) { where(project: project) }
  scope :since, ->(date) { where("occurred_at >= ?", date) }

  # Get human-readable event description
  def event_description
    case event_type
    when DISCOVERED
      I18n.t("vulnerability_history.discovered", package: package_name, severity: severity)
    when FIXED
      I18n.t("vulnerability_history.fixed", package: package_name)
    when UPGRADED
      I18n.t("vulnerability_history.upgraded", from: old_version, to: new_version)
    when DOWNGRADED
      I18n.t("vulnerability_history.downgraded", from: old_version, to: new_version)
    when REAPPEARED
      I18n.t("vulnerability_history.reappeared", package: package_name, severity: severity)
    else
      event_type.humanize
    end
  end

  def event_icon_class
    case event_type
    when DISCOVERED then "text-critical"
    when FIXED then "text-low"
    when UPGRADED then "text-high"
    when DOWNGRADED then "text-medium"
    when REAPPEARED then "text-critical"
    else "text-text-secondary"
    end
  end

  def severity_badge_class
    case severity&.upcase
    when "CRITICAL" then "badge-critical"
    when "HIGH" then "badge-high"
    when "MEDIUM" then "badge-medium"
    when "LOW" then "badge-low"
    else "badge-secondary"
    end
  end
end
