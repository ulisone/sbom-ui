# Compares vulnerabilities between scans and tracks history
class VulnerabilityHistoryService
  attr_reader :project, :current_scan, :previous_scan

  def initialize(project:, current_scan:)
    @project = project
    @current_scan = current_scan
    @previous_scan = find_previous_scan
  end

  def track_changes
    return record_initial_scan if previous_scan.nil?

    current_vulns = vulnerabilities_hash(current_scan)
    previous_vulns = vulnerabilities_hash(previous_scan)

    # Find new vulnerabilities
    new_vuln_ids = current_vulns.keys - previous_vulns.keys
    record_discovered(new_vuln_ids, current_vulns)

    # Find fixed vulnerabilities
    fixed_vuln_ids = previous_vulns.keys - current_vulns.keys
    record_fixed(fixed_vuln_ids, previous_vulns)

    # Find severity changes
    common_ids = current_vulns.keys & previous_vulns.keys
    check_severity_changes(common_ids, current_vulns, previous_vulns)

    # Check for reappearances (vulns that were fixed before but are back)
    check_reappearances(new_vuln_ids, current_vulns)
  end

  def summary
    return {} unless current_scan

    recent_history = project.vulnerability_histories.where(scan: current_scan)

    {
      discovered: recent_history.discovered.count,
      fixed: recent_history.fixed.count,
      severity_changes: recent_history.severity_changes.count,
      total_events: recent_history.count
    }
  end

  private

  def find_previous_scan
    project.scans
           .completed
           .where.not(id: current_scan.id)
           .where("created_at < ?", current_scan.created_at)
           .order(created_at: :desc)
           .first
  end

  def vulnerabilities_hash(scan)
    scan.vulnerabilities.index_by(&:cve_id)
  end

  def record_initial_scan
    current_scan.vulnerabilities.each do |vuln|
      create_history(
        vulnerability_id: vuln.cve_id,
        event_type: VulnerabilityHistory::DISCOVERED,
        severity: vuln.severity,
        package_name: vuln.package_name,
        details: build_vuln_details(vuln)
      )
    end
  end

  def record_discovered(vuln_ids, vulns)
    vuln_ids.each do |cve_id|
      vuln = vulns[cve_id]
      create_history(
        vulnerability_id: cve_id,
        event_type: VulnerabilityHistory::DISCOVERED,
        severity: vuln.severity,
        package_name: vuln.package_name,
        details: build_vuln_details(vuln)
      )
    end
  end

  def record_fixed(vuln_ids, vulns)
    vuln_ids.each do |cve_id|
      vuln = vulns[cve_id]
      create_history(
        vulnerability_id: cve_id,
        event_type: VulnerabilityHistory::FIXED,
        severity: vuln.severity,
        package_name: vuln.package_name,
        details: {
          fixed_in_scan: current_scan.id,
          previous_scan: previous_scan.id
        }
      )
    end
  end

  def check_severity_changes(vuln_ids, current, previous)
    vuln_ids.each do |cve_id|
      curr_vuln = current[cve_id]
      prev_vuln = previous[cve_id]

      next if curr_vuln.severity == prev_vuln.severity

      event_type = severity_increased?(prev_vuln.severity, curr_vuln.severity) ?
        VulnerabilityHistory::UPGRADED : VulnerabilityHistory::DOWNGRADED

      create_history(
        vulnerability_id: cve_id,
        event_type: event_type,
        severity: curr_vuln.severity,
        package_name: curr_vuln.package_name,
        old_version: prev_vuln.severity,
        new_version: curr_vuln.severity,
        details: {
          previous_severity: prev_vuln.severity,
          current_severity: curr_vuln.severity
        }
      )
    end
  end

  def check_reappearances(new_vuln_ids, current_vulns)
    return if new_vuln_ids.empty?

    # Check if any of the "new" vulnerabilities were previously fixed
    previously_fixed = project.vulnerability_histories
                              .fixed
                              .where(vulnerability_id: new_vuln_ids)
                              .pluck(:vulnerability_id)

    previously_fixed.each do |cve_id|
      vuln = current_vulns[cve_id]

      # Update the existing discovered record to reappeared
      recent = project.vulnerability_histories
                      .discovered
                      .where(vulnerability_id: cve_id, scan: current_scan)
                      .first

      recent&.update!(event_type: VulnerabilityHistory::REAPPEARED)
    end
  end

  def severity_increased?(old_severity, new_severity)
    severity_order = { "LOW" => 1, "MEDIUM" => 2, "HIGH" => 3, "CRITICAL" => 4 }
    (severity_order[new_severity] || 0) > (severity_order[old_severity] || 0)
  end

  def create_history(attributes)
    project.vulnerability_histories.create!(
      attributes.merge(
        scan: current_scan,
        occurred_at: current_scan.scanned_at || Time.current
      )
    )
  end

  def build_vuln_details(vuln)
    {
      title: vuln.title,
      cvss_score: vuln.cvss_score,
      package_version: vuln.package_version,
      fixed_version: vuln.fixed_version,
      description: vuln.description&.truncate(500)
    }
  end
end
