<% content_for(:page_title) { @project.name } %>

<div class="flex items-center justify-between mb-6">
  <div>
    <div class="flex items-center gap-2 mb-2">
      <%= link_to projects_path, class: "text-text-secondary hover:text-text-primary" do %>
        Projects
      <% end %>
      <span class="text-text-muted">/</span>
      <span class="text-text-primary"><%= @project.name %></span>
    </div>
    <% if @project.description.present? %>
      <p class="text-text-secondary"><%= @project.description %></p>
    <% end %>
    <% if @project.repository_url.present? %>
      <div class="flex items-center gap-2 mt-2">
        <svg class="w-4 h-4 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
        </svg>
        <a href="<%= @project.repository_url %>" target="_blank" rel="noopener noreferrer" class="text-sm text-primary hover:underline truncate max-w-md">
          <%= @project.repository_url %>
        </a>
      </div>
    <% end %>
  </div>
  <div class="flex items-center gap-2">
    <%= link_to new_project_report_path(@project), class: "btn-secondary" do %>
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      Generate Report
    <% end %>
    <%= link_to new_project_scan_path(@project), class: "btn-primary" do %>
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      New Scan
    <% end %>
    <%= link_to edit_project_path(@project), class: "btn-secondary" do %>
      Edit
    <% end %>
  </div>
</div>

<!-- Vulnerability Summary -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  <div class="card flex items-center gap-4">
    <div class="w-10 h-10 bg-critical-bg rounded-lg flex items-center justify-center">
      <span class="text-critical font-bold"><%= @vulnerability_summary[:critical] %></span>
    </div>
    <div>
      <p class="text-text-secondary text-sm">Critical</p>
    </div>
  </div>
  <div class="card flex items-center gap-4">
    <div class="w-10 h-10 bg-high-bg rounded-lg flex items-center justify-center">
      <span class="text-high font-bold"><%= @vulnerability_summary[:high] %></span>
    </div>
    <div>
      <p class="text-text-secondary text-sm">High</p>
    </div>
  </div>
  <div class="card flex items-center gap-4">
    <div class="w-10 h-10 bg-medium-bg rounded-lg flex items-center justify-center">
      <span class="text-medium font-bold"><%= @vulnerability_summary[:medium] %></span>
    </div>
    <div>
      <p class="text-text-secondary text-sm">Medium</p>
    </div>
  </div>
  <div class="card flex items-center gap-4">
    <div class="w-10 h-10 bg-low-bg rounded-lg flex items-center justify-center">
      <span class="text-low font-bold"><%= @vulnerability_summary[:low] %></span>
    </div>
    <div>
      <p class="text-text-secondary text-sm">Low</p>
    </div>
  </div>
</div>

<!-- Scans -->
<div class="card">
  <h3 class="text-lg font-semibold text-text-primary mb-4">Scan History</h3>

  <% if @scans.any? %>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Status</th>
            <th>Format</th>
            <th>Ecosystem</th>
            <th>Dependencies</th>
            <th>Vulnerabilities</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @scans.each do |scan| %>
            <tr>
              <td><%= scan.created_at.strftime("%Y-%m-%d %H:%M") %></td>
              <td>
                <span class="badge <%= scan.completed? ? 'badge-low' : (scan.failed? ? 'badge-critical' : 'badge-medium') %>">
                  <%= scan.status.titleize %>
                </span>
              </td>
              <td><%= scan.sbom_format_display || "-" %></td>
              <td><%= scan.ecosystem || "-" %></td>
              <td><%= scan.dependencies.count %></td>
              <td>
                <% summary = scan.vulnerability_summary %>
                <div class="flex items-center gap-1">
                  <% if summary[:critical] > 0 %>
                    <span class="badge-critical"><%= summary[:critical] %></span>
                  <% end %>
                  <% if summary[:high] > 0 %>
                    <span class="badge-high"><%= summary[:high] %></span>
                  <% end %>
                  <% if summary[:critical] == 0 && summary[:high] == 0 %>
                    <span class="text-text-muted"><%= scan.total_vulnerabilities %></span>
                  <% end %>
                </div>
              </td>
              <td>
                <%= link_to scan_path(scan), class: "text-primary hover:text-primary-hover" do %>
                  View
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="text-center py-8">
      <p class="text-text-secondary mb-4">No scans yet</p>
      <%= link_to new_project_scan_path(@project), class: "btn-primary" do %>
        Start your first scan
      <% end %>
    </div>
  <% end %>
</div>

<!-- Vulnerability History -->
<div class="mt-6">
  <%= render "projects/vulnerability_history" %>
</div>
